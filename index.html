<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Garage-Atelier M√©canique J.L ‚Äî Gestion</title>
  <style>
    :root{
      --bg:#1b1b1b;
      --card:#262626;
      --accent:#f5c542;
      --text:#e6e6e6;
      --border:#3a3a3a;
      --danger:#ff4d4d;
      --muted:#aaaaaa;
    }
    *{box-sizing:border-box;}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
      margin:0;
      padding:0;
    }
    h1,h2,h3,h4{
      color:var(--accent);
      margin:0 0 10px;
    }
    .muted{color:var(--muted);font-size:0.85rem;}
    a{color:var(--accent);}
    .card{
      background:var(--card);
      padding:18px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:14px;
    }
    input,select,textarea{
      width:100%;
      padding:8px;
      background:#111;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:6px;
      margin-top:6px;
    }
    textarea{min-height:70px;resize:vertical;}
    button{
      background:var(--accent);
      color:#000;
      border:none;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }
    button.ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--accent);
    }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      color:var(--text);
      font-size:0.9rem;
    }
    th,td{
      padding:8px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
    }
    th{
      background:#333;
      color:var(--accent);
    }

    /* --- Layout --- */
    #sidebar{
      position:fixed;
      left:0;
      top:0;
      width:200px;
      height:100%;
      background:#111;
      border-right:1px solid var(--border);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:10;
    }
    .navBtn{width:100%;text-align:left;}
    .navBtn.active{background:var(--accent);color:#000;}

    .topbar{
      position:fixed;
      top:0;
      left:200px;
      right:0;
      height:70px;
      background:#1b1b1b;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      z-index:9;
    }

    #appPages{
      margin-left:200px;
      margin-top:70px;
      padding:20px;
    }

    .page{display:none;}
    .page:first-child{display:block;}

    /* Dashboard cards */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
    }
    .stat-card{
      background:var(--card);
      border-radius:10px;
      border:1px solid var(--border);
      padding:12px;
    }
    .stat-label{font-size:0.85rem;color:var(--muted);}
    .stat-value{font-size:1.3rem;font-weight:700;margin-top:4px;}

    /* Modals */
    .modal-backdrop{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      z-index:9999;
      align-items:center;
      justify-content:center;
    }
    .modal-panel{
      background:var(--card);
      width:750px;
      max-width:95%;
      padding:20px;
      border-radius:12px;
      border:1px solid var(--border);
      max-height:90vh;
      overflow-y:auto;
    }
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2>Menu</h2>
    <button class="navBtn" data-page="page-dashboard">üìä Dashboard</button>
    <button class="navBtn" data-page="page-invoices">üßæ Factures</button>
    <button class="navBtn" data-page="page-clients">üë§ Clients</button>
    <button class="navBtn" data-page="page-vehicles">üöó V√©hicules</button>
    <button class="navBtn" data-page="page-services">üõ†Ô∏è Services</button>
    <button class="navBtn" data-page="page-parts">üî© Pi√®ces</button>
    <button class="navBtn" data-page="page-history">üìú Historique</button>
    <button class="navBtn" data-page="page-settings">‚öôÔ∏è Param√®tres</button>
  </div>

  <!-- HEADER -->
  <div class="topbar">
    <h1 style="font-size:18px;color:var(--accent)">Garage-Atelier M√©canique J.L</h1>
    <button id="btnPrint">Imprimer</button>
  </div>

  <!-- APP CONTENT -->
  <div id="appPages">
    <!-- DASHBOARD -->
    <div class="page" id="page-dashboard">
      <h2>Tableau de bord</h2>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Factures</div><div class="stat-value" id="statInvoices">0</div></div>
        <div class="stat-card"><div class="stat-label">Revenus</div><div class="stat-value" id="statRevenue">0.00 $</div></div>
        <div class="stat-card"><div class="stat-label">Clients</div><div class="stat-value" id="statClients">0</div></div>
        <div class="stat-card"><div class="stat-label">V√©hicules</div><div class="stat-value" id="statVehicles">0</div></div>
        <div class="stat-card"><div class="stat-label">Pi√®ces</div><div class="stat-value" id="statParts">0</div></div>
        <div class="stat-card"><div class="stat-label">Stock faible</div><div class="stat-value" id="statLowStock">0</div></div>
      </div>
    </div>

    <!-- FACTURES (CR√âATION) -->
    <div class="page" id="page-invoices">
      <div class="card">
        <h2>Cr√©er nouvelle facture</h2>
        <label>Client</label><input id="customerName" />
        <label># Facture</label><input id="invoiceNumber" disabled />
        <label>Description</label><input id="jobDesc" />

        <h3>Ajouter une pi√®ce</h3>
        <label>Nom</label><input id="partName" />
        <label>Qt√©</label><input id="partQty" type="number" value="1" />
        <label>Prix</label><input id="partPrice" type="number" />
        <button id="addPart">Ajouter pi√®ce</button>

        <h3>Ajouter main-d‚Äô≈ìuvre</h3>
        <label>Description</label><input id="laborDesc" />
        <label>Heures</label><input id="laborHours" type="number" step="0.1" />
        <label>Taux</label><input id="laborRate" type="number" />
        <button id="addLabor">Ajouter</button>

        <button id="openServicePicker" class="ghost" style="margin-top:10px;">‚ûï Ajouter service enregistr√©</button>

        <h3>Articles</h3>
        <table id="itemsTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Description</th>
              <th>Qt√©</th>
              <th>Prix</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3>Totaux</h3>
        <div>Sous-total : <span id="subTotal">0.00</span> $</div>
        <div>TPS : <span id="gstAmount">0.00</span> $</div>
        <div>TVQ : <span id="qstAmount">0.00</span> $</div>
        <div><b>Total : <span id="totalAmount">0.00</span> $</b></div>

        <button id="saveInvoice">Enregistrer</button>
        <button id="clearItems" class="ghost">Vider</button>
      </div>
    </div>

    <!-- CLIENTS -->
    <div class="page" id="page-clients">
      <h2>Clients</h2>
      <div class="card">
        <input id="clientSearch" placeholder="Rechercher..." />
        <button id="btnAddClient">Ajouter client</button>
      </div>
      <table id="clientsTable">
        <thead>
          <tr>
            <th>Nom</th><th>T√©l</th><th>Email</th><th>Adresse</th><th>V√©hicules</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- V√âHICULES -->
    <div class="page" id="page-vehicles">
      <h2>V√©hicules</h2>
      <table id="vehiclesTable">
        <thead>
          <tr><th>Client</th><th>Marque</th><th>Mod√®le</th><th>Ann√©e</th><th>Plaque</th><th>VIN</th><th>KM</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SERVICES -->
    <div class="page" id="page-services">
      <h2>Services</h2>
      <div class="card">
        <label>Nom du service</label><input id="srvName" />
        <label>Cat√©gorie</label>
        <select id="srvCategory">
          <option>Entretien</option><option>M√©canique g√©n√©rale</option><option>Freins</option><option>Suspension</option>
          <option>Direction</option><option>Refroidissement</option><option>Diagnostic</option><option>√âlectricit√©</option>
          <option>Pneus</option><option>√âchappement</option><option>Transmission</option><option>Moteur</option><option>Divers</option>
        </select>
        <label>Description</label><textarea id="srvDesc"></textarea>

        <h4>Prix fixe</h4><input id="srvPriceFixed" type="number" />
        <h4>OU Heures + taux</h4>
        <label>Heures</label><input id="srvHours" type="number" step="0.1" />
        <label>Taux</label><input id="srvRate" type="number" />

        <button id="srvAddBtn">Ajouter service</button>
      </div>

      <h3>Liste des services</h3>
      <div id="servicesList" style="display:flex;gap:10px;flex-wrap:wrap;"></div>
    </div>

    <!-- PI√àCES -->
    <div class="page" id="page-parts">
      <h2>Inventaire des pi√®ces</h2>

      <div class="card">
        <label>Nom</label><input id="partInvName" />
        <label># de pi√®ce</label><input id="partInvNumber" />
        <label>Cat√©gorie</label>
        <select id="partInvCategory">
          <option>Moteur</option><option>Transmission</option><option>Suspension</option><option>Direction</option>
          <option>Freins</option><option>√âchappement</option><option>√âlectrique</option><option>Tuning</option>
          <option>Fabrication</option><option>Hybride</option><option>Carrosserie</option><option>Pneus</option><option>Divers</option>
        </select>

        <label>Stock</label><input id="partInvQty" type="number" />
        <label>Co√ªt</label><input id="partInvCost" type="number" />
        <label>Prix</label><input id="partInvPrice" type="number" />
        <button id="partInvAddBtn">Ajouter</button>
      </div>

      <input id="partInvSearch" placeholder="Rechercher..." />
      <select id="partInvFilter">
        <option value="">Toutes cat√©gories</option>
        <option>Moteur</option><option>Transmission</option><option>Suspension</option><option>Direction</option>
        <option>Freins</option><option>√âchappement</option><option>√âlectrique</option><option>Tuning</option>
        <option>Fabrication</option><option>Hybride</option><option>Carrosserie</option><option>Pneus</option><option>Divers</option>
      </select>

      <div id="partsInventoryList" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
    </div>
    
    <!-- HISTORIQUE -->
    <div class="page" id="page-history">
      <h2>Historique des factures</h2>

      <table id="historyTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Client</th>
            <th>Description</th>
            <th>Total</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- PARAM√àTRES -->
    <div class="page" id="page-settings">
      <h2>Param√®tres & sauvegarde</h2>

      <div class="card">
        <h3>Sauvegarde</h3>
        <button id="btnExportData">Exporter les donn√©es</button>
        <input id="importFile" type="file" accept="application/json" />
        <button id="btnImportData">Importer les donn√©es</button>
      </div>
    </div>

  </div> <!-- FIN appPages -->


  <!-- MODAL CLIENT -->
  <div id="clientModal" class="modal-backdrop">
    <div class="modal-panel">
      <h2>Client</h2>
      <div id="clientModalContent">Chargement...</div>
      <button id="closeClientModal" class="ghost" style="margin-top:15px;">Fermer</button>
    </div>
  </div>

  <!-- MODAL SERVICE PICKER -->
  <div id="servicePickerModal" class="modal-backdrop">
    <div class="modal-panel">
      <h2>Ajouter un service</h2>

      <label>Filtrer par cat√©gorie</label>
      <select id="servicePickerFilter"></select>

      <div id="servicePickerList" style="margin-top:15px;display:flex;flex-wrap:wrap;gap:12px;"></div>

      <button id="closeServicePicker" class="ghost" style="margin-top:15px;">Fermer</button>
    </div>
  </div>


<!-- ============================ SCRIPT ============================ -->
<script>

const STORAGE = {
  invoices: "ar_invoices_v1",
  clients: "ar_clients_v1",
  services: "ar_services_v1",
  parts: "ar_parts_v1",
  invoiceCounter: "ar_counter_v1"
};

const $ = id => document.getElementById(id);

let INVOICES = [];
let CLIENTS = [];
let SERVICES = [];
let PARTS = [];
let items = [];

  /* ============================================================
   ==========   CHARGEMENT / SAUVEGARDE LOCALSTORAGE   =========
============================================================ */

function loadAllData(){
  INVOICES = JSON.parse(localStorage.getItem(STORAGE.invoices) || "[]");
  CLIENTS  = JSON.parse(localStorage.getItem(STORAGE.clients)  || "[]");
  SERVICES = JSON.parse(localStorage.getItem(STORAGE.services) || "[]");
  PARTS    = JSON.parse(localStorage.getItem(STORAGE.parts)    || "[]");
}

function saveInvoices(){
  localStorage.setItem(STORAGE.invoices, JSON.stringify(INVOICES));
}
function saveClients(){
  localStorage.setItem(STORAGE.clients, JSON.stringify(CLIENTS));
}
function saveServices(){
  localStorage.setItem(STORAGE.services, JSON.stringify(SERVICES));
}
function saveParts(){
  localStorage.setItem(STORAGE.parts, JSON.stringify(PARTS));
}


/* ============================================================
   ======================  INVOICES  ==========================
============================================================ */

function nextInvoiceNumber(){
  let n = Number(localStorage.getItem(STORAGE.invoiceCounter) || 1);
  localStorage.setItem(STORAGE.invoiceCounter, n+1);
  return n;
}

$("invoiceNumber").value = nextInvoiceNumber();


/* ============================================================
   ======================  ITEMS HANDLING  =====================
============================================================ */

function money(n){ return Number(n||0).toFixed(2); }

function renderItems(){
  const tbody = document.querySelector("#itemsTable tbody");
  if(!tbody) return;

  tbody.innerHTML = "";
  let sub = 0;

  items.forEach((it,i)=>{
    const total = it.qty * it.rate;
    sub += total;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${it.type}</td>
      <td>${it.desc}</td>
      <td>${it.qty}</td>
      <td>${money(it.rate)}</td>
      <td>${money(total)}</td>
      <td><button class="ghost" onclick="removeItem(${i})">X</button></td>
    `;
    tbody.appendChild(tr);
  });

  $("subTotal").innerText = money(sub);
  $("gstAmount").innerText = money(sub * 0.05);
  $("qstAmount").innerText = money((sub + sub * 0.05) * 0.09975);
  $("totalAmount").innerText =
    money(sub + (sub * 0.05) + ((sub + sub * 0.05) * 0.09975));
}

function removeItem(i){
  const it = items[i];

  // si item vient de l‚Äôinventaire ‚Üí remettre la quantit√©
  if(it && typeof it.invNumber !== "undefined"){
    const part = PARTS[it.invNumber];
    if(part){
      part.qty += Number(it.qty);
      saveParts();
      renderParts();
    }
  }

  items.splice(i,1);
  renderItems();
}


$("clearItems").onclick = ()=>{
  if(!items.length) return;

  if(!confirm("Vider tous les articles ?")) return;

  items.forEach(it=>{
    if(it.invNumber !== undefined){
      PARTS[it.invNumber].qty += Number(it.qty);
    }
  });
  saveParts();
  items = [];
  renderItems();
};


/* ============================================================
   =====================  AJOUT ARTICLES  ======================
============================================================ */

$("addPart").onclick = ()=>{
  const name = $("partName").value.trim();
  const qty  = Number($("partQty").value||1);
  const price = Number($("partPrice").value||0);

  if(!name) return alert("Nom de pi√®ce requis.");

  items.push({
    type: "Pi√®ce",
    desc: name,
    qty,
    rate: price
  });

  $("partName").value = "";
  $("partQty").value = 1;
  $("partPrice").value = "";

  renderItems();
};

$("addLabor").onclick = ()=>{
  const d = $("laborDesc").value.trim();
  const h = Number($("laborHours").value||0);
  const r = Number($("laborRate").value||0);

  if(!d) return alert("Description requise.");

  items.push({
    type: "Main-d‚Äô≈ìuvre",
    desc: d,
    qty: h,
    rate: r
  });

  $("laborDesc").value = "";
  $("laborHours").value = "";
  $("laborRate").value = "";

  renderItems();
};


/* ============================================================
   =====================  SAUVER FACTURE  ======================
============================================================ */

$("saveInvoice").onclick = ()=>{
  if(!items.length){
    alert("Aucun article dans la facture.");
    return;
  }

  const inv = {
    id: Date.now(),
    number: $("invoiceNumber").value,
    customer: $("customerName").value,
    desc: $("jobDesc").value,
    date: new Date().toLocaleDateString(),
    items: JSON.parse(JSON.stringify(items)),
    total: Number($("totalAmount").innerText)
  };

  INVOICES.push(inv);
  saveInvoices();
  renderHistory();
  refreshDashboard();

  alert("Facture enregistr√©e !");
};


/* ============================================================
   =====================  IMPRIMER FACTURE  ====================
============================================================ */

$("btnPrint").onclick = ()=>{
  if(!$("printArea").innerHTML){
    alert("Aucune facture √† imprimer.");
    return;
  }
  window.print();
};

function printInvoice(i){
  const inv = INVOICES[i];
  if(!inv) return;

  let html = `
    <div class="invoice-header">
      <h1>Garage-Atelier M√©canique J.L</h1>
      <div>
        <div class="muted">Facture #${inv.number}</div>
        <div class="muted">Date : ${inv.date}</div>
      </div>
    </div>

    <h3>Client</h3>
    <p>${inv.customer || "N/A"}</p>

    <h3>Description</h3>
    <p>${inv.desc || "N/A"}</p>

    <h3>Articles</h3>

    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
          <th>Qt√©</th>
          <th>Prix</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
  `;

  let sub = 0;

  inv.items.forEach(it=>{
    const total = it.qty * it.rate;
    sub += total;

    html += `
      <tr>
        <td>${it.type}</td>
        <td>${it.desc}</td>
        <td>${it.qty}</td>
        <td>${money(it.rate)}</td>
        <td>${money(total)}</td>
      </tr>
    `;
  });

  const tps = sub * 0.05;
  const tvq = (sub + tps) * 0.09975;
  const total = sub + tps + tvq;

  html += `
      </tbody>
    </table>

    <div class="invoice-totals">
      <div><span>Sous-total :</span><span>${money(sub)} $</span></div>
      <div><span>TPS :</span><span>${money(tps)} $</span></div>
      <div><span>TVQ :</span><span>${money(tvq)} $</span></div>
      <div><strong>Total :</strong><strong>${money(total)} $</strong></div>
    </div>
  `;

  $("printArea").innerHTML = html;
  window.print();
}


/* ============================================================
   ========================= CLIENTS ===========================
============================================================ */

function renderClientsTable(){
  const tbody = $("#clientsTable tbody");
  tbody.innerHTML = "";

  CLIENTS.forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.name}</td>
      <td>${c.phone||""}</td>
      <td>${c.email||""}</td>
      <td>${c.address||""}</td>
      <td>${(c.vehicles||[]).length}</td>
      <td><button class="ghost" onclick="openClientModal(${c.id})">Voir</button></td>
    `;
    tbody.appendChild(tr);
  });
}


/* ============================================================
   =============== MODAL CLIENT (AJOUT/√âDITION) ================
============================================================ */

function openClientModal(id){
  const modal = $("clientModal");
  modal.style.display = "flex";

  let client = CLIENTS.find(c=>c.id===id) || {
    id: Date.now(),
    name:"",
    phone:"",
    email:"",
    address:"",
    vehicles:[]
  };

  $("clientModalContent").innerHTML = `
    <label>Nom</label><input id="cName" value="${client.name}">
    <label>T√©l√©phone</label><input id="cPhone" value="${client.phone}">
    <label>Email</label><input id="cEmail" value="${client.email}">
    <label>Adresse</label><input id="cAddress" value="${client.address}">

    <h3>V√©hicules</h3>
    <div id="vehList"></div>

    <button id="saveClientBtn">Enregistrer</button>
  `;

  renderClientVehicles(client);

  $("saveClientBtn").onclick = ()=>{
    client.name = $("cName").value;
    client.phone = $("cPhone").value;
    client.email = $("cEmail").value;
    client.address = $("cAddress").value;

    const idx = CLIENTS.findIndex(c=>c.id===client.id);
    if(idx === -1) CLIENTS.push(client);
    else CLIENTS[idx] = client;

    saveClients();
    renderClientsTable();

    $("clientModal").style.display = "none";
  };
}

function renderClientVehicles(client){
  const wrap = $("vehList");
  wrap.innerHTML = "";

  client.vehicles.forEach(v=>{
    wrap.innerHTML += `<div class="small">${v.make} ${v.model} (${v.year})</div>`;
  });
}

$("closeClientModal").onclick = ()=> $("clientModal").style.display="none";


/* ============================================================
   ======================= SERVICES CRUD =======================
============================================================ */

function renderServices(){
  const wrap = $("servicesList");
  wrap.innerHTML = "";

  if(!SERVICES.length){
    wrap.innerHTML = `<div class="muted">Aucun service enregistr√©.</div>`;
    return;
  }

  SERVICES.forEach((srv,i)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.width = "260px";

    const price = srv.priceFixed>0
      ? srv.priceFixed.toFixed(2)+" $"
      : `${srv.hours}h √ó ${srv.rate}$`;

    card.innerHTML = `
      <h3>${srv.name}</h3>
      <div class="small">Cat√©gorie: <b>${srv.category}</b></div>
      <div class="small">${srv.desc||""}</div>
      <div class="small">Prix: <b>${price}</b></div>

      <div style="margin-top:10px;display:flex;gap:8px;">
        <button class="ghost" onclick="editService(${i})">Modifier</button>
        <button class="ghost" onclick="deleteService(${i})">Supprimer</button>
      </div>
    `;

    wrap.appendChild(card);
  });
}

function editService(i){
  const s = SERVICES[i];

  $("srvName").value = s.name;
  $("srvCategory").value = s.category;
  $("srvDesc").value = s.desc;
  $("srvPriceFixed").value = s.priceFixed;
  $("srvHours").value = s.hours;
  $("srvRate").value = s.rate;

  SERVICES.splice(i,1);
  saveServices();
  renderServices();
}

function deleteService(i){
  if(confirm("Supprimer ?")){
    SERVICES.splice(i,1);
    saveServices();
    renderServices();
  }
}

$("srvAddBtn").onclick = ()=>{
  const s = {
    id: Date.now(),
    name: $("srvName").value,
    category: $("srvCategory").value,
    desc: $("srvDesc").value,
    priceFixed: Number($("srvPriceFixed").value||0),
    hours: Number($("srvHours").value||0),
    rate: Number($("srvRate").value||0)
  };

  SERVICES.push(s);
  saveServices();
  renderServices();
};

  /* ============================================================
   ======================= PARTS CRUD ==========================
============================================================ */

function renderParts(){
  const wrap = $("partsInventoryList");
  wrap.innerHTML = "";

  const q = $("partInvSearch").value.toLowerCase();
  const filter = $("partInvFilter").value;

  PARTS.forEach((p,i)=>{
    const hay = `${p.name} ${p.number} ${p.category}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    if(filter && p.category !== filter) return;

    const profit = p.price>0 ? (((p.price - p.cost)/p.price)*100).toFixed(0) : 0;

    const card = document.createElement("div");
    card.className = "card";
    card.style.width = "250px";

    card.innerHTML = `
      <h3>${p.name}</h3>
      <div class="small"># ${p.number}</div>
      <div class="small">Cat√©gorie: <b>${p.category}</b></div>
      <div class="small">Stock: <b>${p.qty}</b></div>
      <div class="small">Co√ªt: ${p.cost.toFixed(2)} $</div>
      <div class="small">Prix: ${p.price.toFixed(2)} $</div>
      <div class="small">Marge: ${profit}%</div>

      <button class="ghost" onclick="editPart(${i})">Modifier</button>
      <button class="ghost" onclick="deletePart(${i})">Supprimer</button>
      <button class="ghost" onclick="addPartToInvoice(${i})">‚ûï √Ä la facture</button>
    `;

    wrap.appendChild(card);
  });
}

function addPartToInvoice(i){
  const p = PARTS[i];
  if(!p) return;

  if(p.qty <= 0){
    alert("Stock insuffisant !");
    return;
  }

  p.qty -= 1;
  saveParts();
  renderParts();

  items.push({
    type: "Pi√®ce (Inventaire)",
    desc: `${p.name} (#${p.number})`,
    qty: 1,
    rate: p.price,
    invNumber: i
  });

  renderItems();
}

function deletePart(i){
  if(!confirm("Supprimer cette pi√®ce ?")) return;
  PARTS.splice(i,1);
  saveParts();
  renderParts();
}

function editPart(i){
  const p = PARTS[i];

  $("partInvName").value = p.name;
  $("partInvNumber").value = p.number;
  $("partInvCategory").value = p.category;
  $("partInvQty").value = p.qty;
  $("partInvCost").value = p.cost;
  $("partInvPrice").value = p.price;

  // remove to re-add
  PARTS.splice(i,1);
  saveParts();
  renderParts();
}

$("partInvAddBtn").onclick = ()=>{
  PARTS.push({
    id: Date.now(),
    name: $("partInvName").value,
    number: $("partInvNumber").value,
    category: $("partInvCategory").value,
    qty: Number($("partInvQty").value),
    cost: Number($("partInvCost").value),
    price: Number($("partInvPrice").value)
  });

  saveParts();
  renderParts();
};


/* ============================================================
   ======================= HISTORIQUE ==========================
============================================================ */

function renderHistory(){
  const tbody = $("#historyTable tbody");
  tbody.innerHTML = "";

  INVOICES.forEach((inv,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${inv.number}</td>
      <td>${inv.date}</td>
      <td>${inv.customer}</td>
      <td>${inv.desc}</td>
      <td>${money(inv.total)}</td>
      <td>
        <button class="ghost" onclick="editInvoice(${i})">Modifier</button>
        <button class="ghost" onclick="printInvoice(${i})">Imprimer</button>
        <button class="ghost" onclick="deleteInvoice(${i})">Supprimer</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}


/* ============================================================
   ======================= DASHBOARD ===========================
============================================================ */

function refreshDashboard(){
  $("statInvoices").innerText = INVOICES.length;
  $("statRevenue").innerText = money(INVOICES.reduce((a,b)=>a+(b.total||0),0))+" $";
  $("statClients").innerText = CLIENTS.length;

  $("statVehicles").innerText =
    CLIENTS.reduce((a,c)=>a + (c.vehicles?.length || 0), 0);

  $("statParts").innerText = PARTS.length;
  $("statLowStock").innerText = PARTS.filter(p=>p.qty<=2).length;
}


/* ============================================================
   ====================== EXPORT / IMPORT =======================
============================================================ */

$("btnExportData").onclick = ()=>{
  const data = {
    invoices: INVOICES,
    clients: CLIENTS,
    services: SERVICES,
    parts: PARTS
  };

  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "garage_backup.json";
  a.click();
};

$("btnImportData").onclick = ()=>{
  const file = $("importFile").files[0];
  if(!file) return alert("Choisir un fichier .json");

  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);

      INVOICES = data.invoices || [];
      CLIENTS  = data.clients  || [];
      SERVICES = data.services || [];
      PARTS    = data.parts    || [];

      saveInvoices();
      saveClients();
      saveServices();
      saveParts();

      renderInvoices();
      renderClientsTable();
      renderHistory();
      renderServices();
      renderParts();
      refreshDashboard();

      alert("Importation r√©ussie !");
    }catch(e){
      alert("Fichier invalide.");
    }
  };
  reader.readAsText(file);
};


/* ============================================================
   ========================== NAVIGATION =======================
============================================================ */

function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  $(id).style.display="block";

  refreshDashboard();
}

document.querySelectorAll(".navBtn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    showPage(btn.dataset.page);
  };
});


/* ============================================================
   ======================= INITIALISATION ======================
============================================================ */

loadAllData();
renderClientsTable();
renderServices();
renderParts();
renderHistory();
refreshDashboard();
renderItems();

</script>

</body>
</html>
